version: '3.8'

services:
  library-admin:
    build: .
    container_name: library-admin
    restart: unless-stopped
    environment:
      # Domain (required for API URL)
      - DOMAIN=${DOMAIN:-library.ptcau.com}

      # Database connection
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-library_bot}
      - DB_USER=${DB_USER:-library_user}
      - DB_PASSWORD=${DB_PASSWORD}

      # Evolution API
      - EVOLUTION_API_URL=${EVOLUTION_API_URL:-https://api.ptcau.com}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - EVOLUTION_INSTANCE=${EVOLUTION_INSTANCE:-ptc}

      # Admin credentials
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}

      # App configuration
      - TIMEZONE=${TIMEZONE:-Asia/Kolkata}

    networks:
      - dokploy-network

    labels:
      - "traefik.enable=true"
      # Frontend (static files) - port 3000
      - "traefik.http.routers.library-admin-frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.library-admin-frontend.entrypoints=websecure"
      - "traefik.http.routers.library-admin-frontend.tls=true"
      - "traefik.http.routers.library-admin-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.library-admin-frontend.priority=1"
      - "traefik.http.services.library-admin-frontend.loadbalancer.server.port=3000"
      # Backend API (WebSocket & API) - port 8000
      - "traefik.http.routers.library-admin-backend.rule=Host(`${DOMAIN}`) && (PathPrefix(`/_event`) || PathPrefix(`/api`))"
      - "traefik.http.routers.library-admin-backend.entrypoints=websecure"
      - "traefik.http.routers.library-admin-backend.tls=true"
      - "traefik.http.routers.library-admin-backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.library-admin-backend.priority=10"
      - "traefik.http.services.library-admin-backend.loadbalancer.server.port=8000"

networks:
  dokploy-network:
    external: true
